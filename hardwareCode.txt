/* ESP32: HC-SR04 + MPU6050 + Buzzer + HTTP POST on FALL
   - Sends JSON POST to Node server when fall is detected.
   - Adds HTTP header "X-API-KEY" for auth.
   - Uses NTP to get ISO timestamp.
   Required libraries:
     - WiFi.h
     - HTTPClient.h
     - Wire.h
     - Adafruit_MPU6050 / Adafruit_Sensor
*/

#include <WiFi.h>
#include <HTTPClient.h>
#include <Wire.h>
#include <Adafruit_MPU6050.h>
#include <Adafruit_Sensor.h>
#include <time.h>

// -------- CONFIG: set these ----------
const char* SSID       = "u";
const char* PASSWORD   = "00000000";
const char* SERVER_URL = "http://10.64.159.188:3000/event"; // Node endpoint
const char* API_KEY    = ""; // must match server setting or leave "" if none

// Pins
const int TRIG_PIN   = 18;
const int ECHO_PIN   = 19;
const int BUZZER_PIN = 23;
const int SDA_PIN    = 21;
const int SCL_PIN    = 22;

// thresholds
const float DIST_THRESHOLD_CM = 15.24; // 6 inches
const float FALL_ANGLE_THRESHOLD = 40.0; // degrees (your code used ~40)

// timing / debounce
const unsigned long FALL_DEBOUNCE_MS = 5000;
unsigned long lastFallMillis = 0;

// NTP
const char* NTP_POOL = "pool.ntp.org";
const long  GMT_OFFSET_SEC = 0; // leave 0 for UTC; Node server will attach server local location/time
const int   DAYLIGHT_OFFSET_SEC = 0;

Adafruit_MPU6050 mpu;

// ---------- helper functions ----------
String isoTimeUTC() {
  time_t now = time(nullptr);
  struct tm timeinfo;
  if (!gmtime_r(&now, &timeinfo)) return String("");
  char buf[30];
  strftime(buf, sizeof(buf), "%Y-%m-%dT%H:%M:%SZ", &timeinfo);
  return String(buf);
}

void setupTime() {
  configTime(GMT_OFFSET_SEC, DAYLIGHT_OFFSET_SEC, NTP_POOL);
  Serial.print("Syncing time");
  time_t now = time(nullptr);
  unsigned long start = millis();
  while (now < 24*3600 && millis() - start < 5000) {
    delay(200);
    Serial.print(".");
    now = time(nullptr);
  }
  Serial.println();
}

// HC-SR04 distance function (cm)
float measureDistanceCM() {
  digitalWrite(TRIG_PIN, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);

  unsigned long duration = pulseIn(ECHO_PIN, HIGH, 30000); // timeout 30ms
  if (duration == 0UL) return -1.0;
  float cm = (duration / 2.0) / 29.1;
  return cm;
}

void buzzOnce(int ms=200) {
  digitalWrite(BUZZER_PIN, HIGH);
  delay(ms);
  digitalWrite(BUZZER_PIN, LOW);
}

// send JSON POST to server
void sendEventToServer(const char* eventType, float angle, float distance) {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("WiFi not connected, cannot send event.");
    return;
  }

  HTTPClient http;
  http.begin(SERVER_URL);
  http.addHeader("Content-Type", "application/json");
  if (strlen(API_KEY) > 0) http.addHeader("X-API-KEY", API_KEY);

  // build payload
  String payload = "{";
  payload += "\"deviceId\":\"stick-001\",";
  payload += "\"event\":\""; payload += eventType; payload += "\",";
  payload += "\"timestamp\":\""; payload += isoTimeUTC(); payload += "\",";
  payload += "\"angle\":" + String(angle, 2) + ",";
  payload += "\"distance_cm\":" + String(distance, 2);
  payload += "}";

  int code = http.POST(payload);
  if (code > 0) {
    Serial.printf("POST %s -> %d\n", eventType, code);
    String resp = http.getString();
    Serial.println(resp);
  } else {
    Serial.printf("POST failed, err: %d\n", code);
  }
  http.end();
}

// get tilt angle using Adafruit MPU6050; returns angle from vertical in degrees
float getTiltAngle() {
  sensors_event_t a, g, temp;
  mpu.getEvent(&a, &g, &temp);
  float ax = a.acceleration.x;
  float ay = a.acceleration.y;
  float az = a.acceleration.z;
  float angle = atan2(sqrt(ax*ax + ay*ay), az) * 180.0 / PI;
  return angle;
}

// ---------- setup & loop ----------
void setup() {
  Serial.begin(115200);
  delay(200);

  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
  pinMode(BUZZER_PIN, OUTPUT);
  digitalWrite(TRIG_PIN, LOW);
  digitalWrite(BUZZER_PIN, LOW);

  // I2C and MPU
  Wire.begin(SDA_PIN, SCL_PIN);
  if (!mpu.begin()) {
    Serial.println("MPU6050 not found. Check wiring.");
    while (1) delay(10);
  }
  Serial.println("MPU6050 ok");
  mpu.setAccelerometerRange(MPU6050_RANGE_8_G);
  mpu.setGyroRange(MPU6050_RANGE_500_DEG);
  mpu.setFilterBandwidth(MPU6050_BAND_5_HZ);

  // WiFi
  WiFi.begin(SSID, PASSWORD);
  Serial.print("Connecting WiFi");
  unsigned long start = millis();
  while (WiFi.status() != WL_CONNECTED && millis() - start < 20000) {
    delay(300);
    Serial.print(".");
  }
  Serial.println();
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("WiFi connected.");
  } else {
    Serial.println("WiFi connection timed out; continue offline.");
  }

  // NTP time
  setupTime();
}

void loop() {
  float dist = measureDistanceCM();
  float angle = getTiltAngle();

  Serial.print("Distance(cm): ");
  if (dist < 0) Serial.print("OutOfRange");
  else Serial.print(dist, 2);
  Serial.print(" | Angle: ");
  Serial.println(angle, 2);

  // object near -> buzz
  if (dist > 0 && dist <= DIST_THRESHOLD_CM) {
    buzzOnce(150);
  }

  // fall detection: angle < threshold (flat)
  unsigned long now = millis();
  if (angle < FALL_ANGLE_THRESHOLD) {
    // debounce falls
    if (now - lastFallMillis > FALL_DEBOUNCE_MS) {
      Serial.println("FALL DETECTED -> sending to server");
      buzzOnce(400);
      sendEventToServer("fall", angle, dist < 0 ? -1.0 : dist);
      lastFallMillis = now;
    }
  }

  delay(300); // main loop rate
}